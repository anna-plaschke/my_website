---
categories:
- ""
- ""
date: "2020-09-14T22:42:51-05:00"
description: Does school enrollment and GDP per capita affect the fertility rate? How has mortality rate for under 5 changed by region?
draft: false
image: pic10.jpg
keywords: ""
slug: blog8
title: Life Expectancy, School enrollment, Fertility Rate and GDP
subtitle: Various analyses
---

```{r, setup, include=FALSE}
knitr::opts_chunk$set(
  message = FALSE, 
  warning = FALSE, 
  tidy=FALSE,     # display code as typed
  size="small")   # slightly smaller font for code
options(digits = 3)

# default figure size
knitr::opts_chunk$set(
  fig.width=8, 
  fig.height=8,
  fig.align = "center"
)
```


```{r load-libraries, include=FALSE}
library(tidyverse)  # Load ggplot2, dplyr, and all the other tidyverse packages
library(mosaic)
library(ggthemes)
library(lubridate)
library(here)
library(skimr)
library(janitor)
library(httr)
library(readxl)
library(vroom)
library(infer)
library(patchwork)
library(kableExtra)
library(scales)
```


## Fertiliy Rate, School Entrollment, Life Expectancy and GDP
In this project I want to analyze the relationship between school enrollment, fertility rate, life expectancy and GDP per capita by regions. 

### Loading, inspecting and joining datasets

**Loading data**

The first step, is to load the data: I load the gapminder life expectancy data using read_csv to convert the csv files. The worldbank data instead is loaded from a package wbstats. Because I don't need all the data I select the indicators I am interested in and filter by indicator, start- and end-date. Last but not least, I create the dataset countries from the wbstats package.


```{r, get_data, cache=TRUE}

#load life expectancy data
life_expectancy <- read_csv(here::here("static","data","life_expectancy_years.csv"))

# get World bank data using wbstats
indicators <- c("SP.DYN.TFRT.IN","SE.PRM.NENR", "SH.DYN.MORT", "NY.GDP.PCAP.KD")

library(wbstats)

worldbank_data <- wb_data(country="countries_only", #countries only- no aggregates like Latin America, Europe, etc.
                          indicator = indicators, 
                          start_date = 1960, 
                          end_date = 2016)

# get a dataframe of information regarding countries, indicators, sources, regions, indicator topics, lending types, income levels,  from the World Bank API 
countries <-  wbstats::wb_cachelist$countries

```

**Inspecting the dataframes (life_expectancy, worldbank_data)**

Before joining the datasets I need to tidy the data first. 
I skim the datasets to get a basic understanding of the structure, the missingness and the variable types. 

```{r evaluating_the_data, echo=TRUE, results='hide'}

#we first skim the dataset to find missing values and understand the structure of the datatset

skim(worldbank_data)
skim(life_expectancy)

```
All the three datasets have extensive missingness. Notably, in the World Bank data, Primary School enrollment has just a 33.4% complete rate. In the Life Expectancy dataset, there is very low levels of missingness relative to the data size, with approximately 98% completeness across variables (whether retrospective or forecast). 

**Tidying datasets**

Then I use the function picot_longer() to tidy the datasets where needed creating life_expectancy_clean. In this case, I did it for life expectancy. Because I will not need a different structure for the worldbank data I don't tidy this dataset. Furthermore, I change the data type of the variable "year" in life_expectancy_clean to numerical ones to be able to join them with the worlbank data. I change also the name of the variables of the worldbank data to more meaningful names.
To control the changes made, I skim the cleaned datasets.
```{r cleaning_the_data, , echo=TRUE, results='hide'}
#we clean the data by tidying it up (tidyr)
life_expectancy_clean <- life_expectancy %>% 
  pivot_longer(names_to="year", values_to="life_expect", cols= -country) %>% 
  transform(year = as.numeric(year)) #in order to be able to join the three datasets we need the same data types


worldbank_data_clean <- worldbank_data %>% 
  #we change the names to have more meaningful names, but we don't use pivot_longer as this is not needed to resolve the questions
  rename("GDP_per_capita"=NY.GDP.PCAP.KD, 
         "School_enrollment_primary"= SE.PRM.NENR, 
         "Mortality_rate_under5"=SH.DYN.MORT,
         "Fertility_rate" =SP.DYN.TFRT.IN, 
         "year"=date)

#we check if the data types have been changed
skim(life_expectancy_clean)
skim(worldbank_data_clean)

```

**Adding key for countries**

In the various datasets the countries are named slightly different. Therefore, I am adding the countrycode "iso3c" to all datasets. After checking the result, I add the missing countries ("Kosovo" and "Channel Islands") manually.  
```{r adding_the_iso3c_code}

#creating iso3c code to join datasets and joining datasets
library(countrycode)
life_expectancy_clean <-life_expectancy_clean %>% 
  mutate("iso3c" = countrycode(life_expectancy_clean$country, origin = 'country.name', destination = 'iso3c', #creating the iso3c column to join
                               custom_match = c("Kosovo"="XKX", "Channel Islands" ="CHI")))  #joining the missing 2 countries manually
```
As we found 46,483 missing observations by only merging by "country", we created the iso3c code for the dataset life_expectancy. Two countries, "Channel Islands" and "Kosovo" have to be matched with the country dataset manually.

Let's check if all countries are assigned:
```{r check_to_join_the_data}

#we check if we can match correctly by: 
region_missing <- worldbank_data_clean %>% 
  full_join(life_expectancy_clean, by=c("country", "year")) %>% #we don't want to lose data  
  left_join(select(countries, c("country", "region")), by= c("country")) #We don't want to lose values
unique(region_missing[is.na(region_missing$region),]$country)

```

**Joining datasets**

Finally, I perform the relevant join function. In order to select the correct join function I look at the different [join operations](http://r4ds.had.co.nz/relational-data.html).
```{r joining_the_data, echo=TRUE, results='hide'}

worldbank_life_expectancy <- worldbank_data_clean %>% 
  full_join(life_expectancy_clean,by=c("iso3c", "year")) %>%  #we don't want to lose data
  select(!c("country", "country.x", "country.y")) # we don't want to have plenty different values for country

# adding regions and countryname from the datset countries
worldbank_life_expectancy_region <- worldbank_life_expectancy %>% 
  left_join(select(countries, c("iso3c", "region","country")), by= c("iso3c"))


unique(worldbank_life_expectancy_region[is.na(worldbank_life_expectancy_region$region),]$country) #identify missing values by region
skim(worldbank_life_expectancy_region) #check the new dataset for missingness

```
We decide to use the full_join() function to join the three datasets in order to not lose any of the values. 


### What is the relationship between fertility rate and GDP per capita?
To answer the question I generate a scatterplot with a smoothing line to report my results and I facet by region.

```{r fertility_rate_GDP, fig.width=15, fig.height=8}

ggplot(worldbank_life_expectancy_region, aes(x=GDP_per_capita, y=Fertility_rate))+ 
  geom_point(alpha=0.1, na.rm=TRUE)+
  geom_smooth(na.rm=TRUE)+
  facet_wrap(~region, nrow =2, scales = "free")+ #changed scale
  theme_fivethirtyeight()+
  theme(axis.title = element_text())+
  labs(x="GDP Per Capita", y= "Fertility Rate", title="The Fertility Rate in Rich Countries is Decreasing", subtitle = "Relationship between fertility rate (average number of children per woman) and GDP per capita ($)")+
  scale_x_continuous(labels = scales::dollar)+ #added dollar signs
  NULL

```
These faceted plots demonstrate a clear relationship for all regions besides Middle East & North Africa and Sub-Saharan Africa. Evidently, in all other regions, fertility rate falls sharply as GDP per capita rises, until a certain GDP threshold, at which point further increases in GDP/capita is no longer correlated with drastic changes in fertility rate. This suggests a clear negative correlation between fertility, but only in countries with relatively low GDP per capita, where GDP increases have a marked effect on fertility. Indeed, we find that as GDP per capita rises, healthcare and education access and provision improves, child mortality rates fall, and families are capable of raising the number of children they desire without the need to have many more children (high fertility rates) to hedge against potential risks. 

In the two regional outliers, we find that while at relatively low levels of GDP per capita, GDP per capita increases are correlated with decreased fertility rates, past a certain point increased GDP per capita is positively correlated with fertility rates. This u-shaped relationship is explained by the fact that in early stages of development, families choose to have many children to 'hedge' against high mortality rates, since children are assets in the labour market. Therefore, in countries with relatively low levels of GDP per capita, fertility rates are high. However, as GDP per capita increases, families can afford better healthcare and nutrition and therefore child mortality falls, meaning fertility rates decrease in line with mortality rates. However, once GDP per capita has reached a relatively high point, families are then sufficiently well-off to sustain larger families, and children become luxury goods, meaning fertility rates increase with disposable income. 

### Is there a relationship between primary school enrollment and fertility rate?

To answer that question I create a scatterplot between primary school and fertility rate:

```{r primary_enrolment_and_fertility, fig.width=13, fig.height=5, fig.align="centre"}

p1 <- ggplot(worldbank_life_expectancy_region, aes(x=School_enrollment_primary, y=Fertility_rate))+ 
  geom_smooth(se=FALSE, na.rm=TRUE, size=0.3)+
  theme_fivethirtyeight()+
  theme(axis.title = element_text(), legend.title=element_blank())+
  labs(x="Primary School Enrollment (%)", y= "Fertility Rate", subtitle = "Relationship between school enrollment and fertility rate \n between 1960 and 2016 across all regions") + scale_x_continuous(breaks=seq(0, 100, by = 10), limits=c(0,100)) + scale_y_continuous(breaks=seq(2, 7, by = 1), limits=c(2,7))



p2 <-ggplot(worldbank_life_expectancy_region, aes(x=School_enrollment_primary, y=Fertility_rate, colour=region))+ 
  geom_smooth(se=FALSE, na.rm=TRUE, size=0.3)+
  theme_fivethirtyeight()+
  theme(axis.title = element_text(), legend.title=element_blank())+
  labs(x="Primary School Enrollment (%)", y= "Fertility Rate", subtitle = "Relationship between school enrollment and fertility rate \nbetween 1960 and 2016 by region") + scale_x_continuous(breaks=seq(0, 100, by = 10), limits=c(0,100)) + scale_y_continuous(breaks=seq(2, 7, by = 1), limits=c(2,7))

p1+p2+ plot_annotation('Primary School Enrollment is Negatively Correlated with Fertility Rate Across All Regions')

```
The scatterplots above depict a strong relationship between fertility rate and primary school enrollment. On average, across all regions, higher the school enrollment rate is correlated with a lower fertility rate. This is not surprising, as with an education women have greater job opportunities and are less dependent on raising a family to provide children for family labour. 

This relationship is most pronounced in the Middle East & North Africa and South Asia, which shows the steepest negative correlation between primary school enrolment and fertility, though only in the 75%-100% school enrollment interval. This demonstrates how the relationship between the two variables is relatively weak at lower levels of school enrolment, and becomes pronounced only when school enrollment increases from an already relatively high level, i.e. from around 75% enrolment to 100% enrollment. Indeed, while increasing from 25% to 75% enrolment is correlated with a decrease of approximately 1 in fertility rate, increasing from 75% to 100% school enrolment is correlated with a decrease in fertility rate of approximately 2.

This implies that fertility rates are only consistently and strongly negatively correlated with primary school enrollment once enrollment has surpassed a certain threshold, which appears to be approximately 75%. This suggests that women only really start to choose not to have children once a sufficiently large portion of their country/region is educated, though the reason for this is unclear. 


### How has mortality rate for under 5 changed by region?
In each region, I am looking for the top 5 countries that have seen the greatest improvement, as well as those 5 countries where mortality rates have had the least improvement or even deterioration.

First, I look at the general trend and the trend in each region:

```{r mortality_rate_by_region, fig.height=5, fig.width=10, fig.align="centre"}

ggplot(worldbank_life_expectancy_region, aes(x=year, y=Mortality_rate_under5, colour=region))+ 
  geom_smooth(se=FALSE, na.rm=TRUE, size=0.5)+
  theme_fivethirtyeight()+
  theme(axis.title = element_text(), legend.title=element_blank())+
  labs(x="", y= "Mortality Rate (per 1,000 live births)", title="Under-5 Child Mortality Rate Has Decreased in All World Regions Since 1960", subtitle = "Evolution of under-5 child mortality rate by region, 1960-2016") + scale_x_continuous(breaks=seq(1960, 2016, by = 5), limits=c(1960,2016)) + scale_y_continuous(breaks=seq(0, 250, by = 25), limits=c(0,250)) + NULL

```
We can see that the Mortality Rates for the given 1960-2016 period have declined in every Region. It is important to note that "North America","Latin America & Caribbean" and "Middle East & North Africa" have shown convexity in their decline and hence the change in Mortality Rates was greater earlier on in these regions. In particular, Sub-Saharan Africa has seen the most recent and pronounced improvement in under-5 child mortality rates, though rates remain considerably higher in this region  than the rest of the world. South Asia has experienced a more prolonged and steep decline in its child mortality rate, resulting in it falling from being the region with the highest child mortality rate in 1960 to a rate similar to most other regions, besides Europe & Central Asia and North America. Let us look at the country wide trends:

```{r country_wide_mortality_rates, fig.height=10, fig.width=15}

#we plot country-wide under-5 child mortality over time
 ggplot(data = worldbank_life_expectancy_region , mapping = aes(x = year , y = Mortality_rate_under5 , colour= country))+
   geom_point(size=0.5, na.rm=TRUE) +
   geom_smooth(se = FALSE,size=0.5, na.rm=TRUE) +
   facet_wrap(~region, scales="free") +  theme_fivethirtyeight()+
  theme(axis.title = element_text(), legend.title=element_blank())+
   theme(legend.position="none") + labs(x="", y= "Mortality Rate (per 1,000 live births)", title="There are Country-Level Differences in Under-5 Mortality Rates Within Regions", subtitle = "Evolution of under-5 child mortality rate by country within each region, 1960-2016") + scale_x_continuous(breaks=seq(1960, 2016, by = 5), limits=c(1960,2016)) 

```
We can see that the plots for each country are monotonically decreasing. There is only one instance of a country's child mortality rate in the "Sub-Saharan Africa" region that is not monotonous. Hence, we can conclude that the "Absolute Difference in Mortality Rates" and "Percentage Change in Mortality Rates" in the years where data is available for a country are sensible metrics to gauge the improvement in mortality rates. 

Finally, let us then find out the 5 countries in each region with greatest and least improvement in mortality rates:

```{r ranked_mortality_rate_changes}

change_mortality<-worldbank_life_expectancy_region %>%
  group_by(region,country) %>%
  arrange(desc(-year))%>%
        summarise(first_value = first(na.omit(Mortality_rate_under5)),
            last_value = last(na.omit(Mortality_rate_under5)),
            count_years = length(na.omit(Mortality_rate_under5))) %>%
  mutate(rate_diff = last_value- first_value,
         rate_diff_percent= -rate_diff/first_value)

top5_percent_change<- change_mortality %>%
  group_by(region) %>%
  select(1:2,6:7) %>% 
  slice_max(order_by = rate_diff_percent,n=5)
top5_absolute_change <- change_mortality %>%
  group_by(region) %>%
  select(1:2,6:7) %>% 
  slice_min(order_by = rate_diff,n=5)
bottom5_percent_change <- change_mortality %>%
  group_by(region) %>%
  select(1:2,6:7) %>% 
  slice_max(order_by = (-rate_diff_percent),n=5)
bottom5_absolute_change <- change_mortality %>%
  group_by(region) %>%
  select(1:2,6:7) %>% 
  slice_min(order_by = (-rate_diff),n=5)

kbl(top5_percent_change,col.names=c("Region","Country", "Change in Number of Deaths per 1,000 Live Births", "Change (%)"), caption="Improvement in Under-5 Mortality Rate: Top 5 Countries in Each Region, Ranked by % Change") %>%
kable_styling()

kbl(top5_absolute_change,col.names=c("Region","Country", "Change in Number of Deaths per 1,000 Live Births", "Change (%)"), caption="Improvement in Under-5 Mortality Rate: Top 5 Countries in Each Region, Ranked by Absolute Change") %>%
kable_styling()

kbl(bottom5_percent_change,col.names=c("Region","Country", "Change in Number of Deaths per 1,000 Live Births", "Change (%)"), caption="Improvement in Under-5 Mortality Rate: Worst 5 Countries in Each Region, Ranked by % Change") %>%
kable_styling()

kbl(bottom5_absolute_change,col.names=c("Region","Country", "Change in Number of Deaths per 1,000 Live Births", "Change (%)"), caption="Improvement in Under-5 Mortality Rate: Worst 5 Countries in Each Region, Ranked by Absolute Change") %>%
kable_styling()

```
The tables above demonstrate the top 5 countries in each region that have seen the greatest improvement in under 5 child mortality rate over time (as ranked by percentage and absolute value), as well as the worst 5 countries which have seen the smallest improvement in under 5 child mortality rate over time (as ranked by percentage and absolute value).

